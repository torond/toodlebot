<!DOCTYPE html>
<html>
<head>
    <link rel="stylesheet" href="https://npmcdn.com/flatpickr/dist/themes/airbnb.css">
    <style>
        :root {
            --custom-width-full: 100%;
            --custom-width-day: calc(var(--custom-width-full) / 7);
            place-items: center;
        }

        .custom-btn-holder {
            display: flex;
            position: fixed;
            left: 0;
            right: 0;
            bottom: 0;
        }

        .custom-btn-holder button {
            flex-grow: 1;
        }

        .flatpickr-calendar {
            width: var(--custom-width-full);
        }

        .dayContainer {
            width: var(--custom-width-full);
            max-width: var(--custom-width-full);
            min-width: var(--custom-width-full);
        }

        .flatpickr-days {
            width: var(--custom-width-full);
        }

        .flatpickr-day {
            max-width: var(--custom-width-day);
        }

        .final {
            position: absolute;
            width: 10px;
            height: 10px;
            border-radius: 150px;
            bottom: 3px;
            left: calc(50% - 5px);
            display: block;
            background: green;
        }

        .final.no {
            background: indianred;
        }

        .test {
            position: absolute;
            right: 5px;
            bottom: 5px;
        }
    </style>
</head>
<body>
<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>

<div class="picker" id="pkr"></div>
<p>{{config.description}}</p>

{{#data.numberOfParticipants}}
    <p>{{data.numberOfParticipants}} participants so far.</p>
{{/data.numberOfParticipants}}

<div class="custom-btn-holder">
    <button type="button">Cancel</button>
    {{#config.hasConfirmButton}}
        <button id="confirm-button" type="button">Confirm</button>
    {{/config.hasConfirmButton}}
</div>

<script>
    {{#data.numberOfParticipants}}
        const numberOfParticipants = {{data.numberOfParticipants}};
    {{/data.numberOfParticipants}}

    {{#data.participationsMap}}
        const participationsMap = { {{#content}}"{{key}}": {{value}}, {{/content}} };
    {{/data.participationsMap}}

    {{#data.finalDates}}
        const finalDates = [{{#content}}"{{.}}", {{/content}}];
    {{/data.finalDates}}

    /*function getNumberOfParticipants(date) {
        return participationsMap[date.format]
    }*/

    function formatDate(date) {
        return date.getFullYear() + '-'
                + ('0' + (date.getMonth() + 1)).slice(-2) + '-'
                + ('0' + date.getDate()).slice(-2);
    }

    const fp = flatpickr("#pkr", {
        inline: true,
        disableMobile: "true",
        static: true, //necessary?
        mode: "multiple",onDayCreate: function(dObj, dStr, fp, dayElem){
            var formattedDate = formatDate(dayElem.dateObj)
            {{#data.participationsMap}}
                participantsToday = participationsMap[formattedDate];
                if (participantsToday != null) {
                    console.log(participantsToday)
                    dayElem.innerHTML += "<span class='test'>" + participantsToday.length.toString() + "/{{data.numberOfParticipants}}</span>";
                }
            {{/data.participationsMap}}
            {{#data.finalDates}}
                if (finalDates.includes(formattedDate)) {
                    dayElem.innerHTML += "<span class='final'></span>"
                }
            {{/data.finalDates}}
        },
        {{#data.pickedDates}}defaultDate: [{{#content}}"{{.}}", {{/content}}],{{/data.pickedDates}}
        {{#data.pickableDates}}enable: [{{#content}}"{{.}}", {{/content}}],{{/data.pickableDates}}
    });



    xhr = new XMLHttpRequest();
    xhr.open('POST', '{{config.confirmRecipientUrl}}{{#data.uuid}}/{{data.uuid}}{{/data.uuid}}');
    xhr.setRequestHeader('Content-Type', 'application/json');
    xhr.onload = function () {
        if (xhr.status !== 200) {
            alert('Request failed. Returned status of ' + xhr.status);
        }
    };
    document.getElementById("confirm-button").addEventListener("click",
            function () {
                xhr.send(JSON.stringify(fp.selectedDates.map(x => formatDate(x))))
            },
            false
    );
</script>
</body>
</html>
